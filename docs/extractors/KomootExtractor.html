<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>extractors.KomootExtractor API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>extractors.KomootExtractor</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import logging
import os
import re
from itertools import islice
from time import sleep

import pandas as pd
from typing import Dict, List

from bs4 import BeautifulSoup
from selenium.common import ElementNotInteractableException, NoSuchElementException
from selenium.webdriver.chrome.webdriver import WebDriver
from selenium.webdriver.common.by import By

from src.extractors import SeleniumUtil
from src.model.Komoot.Route import KomootRoute
import keyring


class KomootExtractor:
    &#34;&#34;&#34;
    A class used to extract data from Komoot.com

    Attributes
    ----------
    base_url : str
        a url string used as the base url for all other urls
    discover_url : str
        A combination of the base_url and the discover url
    region_url : str
        A combination of the base_url and the regions url
    tours_url : str
        A combination of the base_url and the tours url

    Methods
    -------
    extract()
        Extracts all relevant data from the Komoot website.
    &#34;&#34;&#34;

    base_url = &#39;https://www.komoot.com&#39;
    discover_url = base_url + &#39;/discover/hiking-trails&#39;
    region_url = base_url + &#39;/guide&#39;
    route_url = base_url + &#39;/smarttour&#39;
    login_url = &#39;https://account.komoot.com/signin&#39;
    max_retries = 3
    retry_wait_seconds = 5

    page_objects = {
        &#39;discover&#39;: {
            &#39;filter_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/main/section[1]/div[2]/div/div[1]/div/div/button[1]&#39;,
            &#39;filter_close_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/main/section[1]/div[2]/div/div[2]/div/div[3]/div[2]/button/span&#39;,
            &#39;filter_country_ch_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/main/section[1]/div[2]/div/div[2]/div/div[2]/div/div[13]/label&#39;,
            &#39;next_page_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/main/section[1]/div[2]/div/div[3]/div[3]/button&#39;,
            &#39;first_region_div&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/main/section[1]/div[2]/div/div[2]/div/div[1]/div/div[3]/a&#39;
        },
        &#39;region&#39;: {
            &#39;tour_title_attr&#39;: &#39;data-test-id=&#34;tour_title&#34;&#39;,
            &#39;tours_list&#39;: &#39;#pageMountNode &gt; div &gt; div.tw-bg-beige-light &gt; div.u-bg-desk-column &gt; div &gt; section &gt; div &gt; div &gt; div &gt; div.tw-w-full.lg\:tw-w-3\/5 &gt; div &gt; div &gt; div:nth-child(2) &gt; div &gt; div:nth-child(2) &gt; ul&#39;,
        },
        &#39;tour&#39;: {
            &#39;title_lbl&#39;: &#39;//*[@id=&#34;title&#34;]/div[2]/h1&#39;,
            &#39;difficulty_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[1]/div/div&#39;,
            &#39;duration_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[2]/div/div/div[2]/div/div/span&#39;,
            &#39;distance_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[3]/div/div/div[2]/span&#39;,
            &#39;speed_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[4]/div/div/div[2]/div/div/span&#39;,
            &#39;elevation_up_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[5]/div/div/div[2]/span&#39;,
            &#39;elevation_down_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[6]/div/div/div[2]/span&#39;,
            &#39;gpx_download_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[2]/div/div/div/div[1]/div/div[2]/div/ul/li[3]/button&#39;
        },
        &#39;login&#39;: {
            &#39;email_input&#39;: &#39;//*[@id=&#34;email&#34;]&#39;,
            &#39;password_input&#39;: &#39;//*[@id=&#34;password&#34;]&#39;,
            &#39;continue_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[1]/div[2]/div/div[1]/form/div[4]/button&#39;,
            &#39;login_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[1]/div[2]/form/div/div[5]/button&#39;
        },
        &#39;cookie_banner&#39;: {
            &#39;accept_btn&#39;: &#39;//*[@id=&#34;gdpr_banner_portal&#34;]/div/div/div/div[2]/div/div[1]/button&#39;,
            &#39;decline_btn&#39;: &#39;//*[@id=&#34;gdpr_banner_portal&#34;]/div/div/div/div[2]/div/div[3]/button&#39;
        }
    }

    def __init__(self, driver: WebDriver, output_path: str, gpx_download_path: str) -&gt; None:
        &#34;&#34;&#34;
        Parameters
        ----------
        driver : WebDriver
            The Selenium WebDriver used to interact with the browser
        &#34;&#34;&#34;
        self.driver = driver
        self.driver.implicitly_wait(15)
        self.output_path = output_path
        self.gpx_download_path = gpx_download_path
        self.logger = logging.getLogger(__name__)

    def extract(self) -&gt; None:
        &#34;&#34;&#34;Extracts all relevant data from the Komoot website.&#34;&#34;&#34;

        self.logger.info(&#39;Starting Komoot extraction...&#39;)
        regions = self.extract_ch_regions()

        existing = self.read_existing_data()

        routes: List[KomootRoute] = existing

        # split regions dictionary into chunks of 20
        for chunk in self.chunks(regions, 20):
            for region in chunk:
                for route in self.extract_routes_from_region(region, chunk[region]):

                    # check if route is already in existing routes by comparing the link
                    if route not in [r.link for r in routes]:
                        routes.append(self.extract_route(route))
                        sleep(5)  # Sleep 5 seconds to avoid getting rate limited

            self.logger.info(&#39;Saving current state...&#39;)
            self.save(routes)  # Save routes after each chunk to avoid losing data
            sleep(120)  # Sleep for 120 seconds to avoid getting rate limited

        self.logger.info(&#39;Finished Komoot extraction.&#39;)

        self.logger.info(&#39;Saving Komoot data...&#39;)
        self.save(routes)
        self.logger.info(&#39;Saved Komoot data.&#39;)

    def extract_gpx(self) -&gt; None:
        &#34;&#34;&#34; Extracts the GPX files for all routes in the output file.  &#34;&#34;&#34;

        existing = self.read_existing_data()

        self.handle_komoot_login()

        existing_gpx_files = os.listdir(self.gpx_download_path)

        for idx, route in enumerate(existing):
            pattern = re.compile(route.title + &#34;\.gpx$&#34;)
            for filepath in existing_gpx_files:
                if pattern.match(filepath):
                    self.logger.info(f&#39;GPX for route {route.title} already exists. Skipping...&#39;)
                    continue

            self.logger.info(f&#39;Downloading GPX for route {route.title}...&#39;)

            link = route.link.replace(&#39;https://www.komoot.com/&#39;, &#39;https://www.komoot.de/&#39;)

            self.driver.get(link)
            self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;gpx_download_btn&#39;]).click()
            self.logger.info(f&#39;Downloaded GPX for route {route.title}.&#39;)
            sleep(5)  # Sleep 5 seconds to avoid getting rate limited
            if idx % 40 == 0:
                self.logger.info(&#39;Sleeping for 120 seconds...&#39;)
                sleep(120)

    def extract_ch_regions(self) -&gt; Dict[str, str]:
        &#34;&#34;&#34;Extracts all regions from the Komoot discover page. &#34;&#34;&#34;

        self.logger.info(&#39;Extracting all regions in Switzerland...&#39;)

        self.driver.get(self.discover_url)
        self.handle_cookie_banner()

        # Filter region to Switzerland
        self.logger.debug(&#39;Filter region to Switzerland...&#39;)
        self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;filter_btn&#39;]).click()
        self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;filter_country_ch_lbl&#39;]).click()
        self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;filter_close_btn&#39;]).click()

        regions = {}

        # Get all regions
        while True:
            regions = regions | self.extract_region_page()

            # Check if there is a next page button
            try:
                SeleniumUtil.scroll_to_position(self.driver, 1500)
                self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;next_page_btn&#39;]).click()
            except ElementNotInteractableException:
                self.logger.info(&#39;No more pages to extract.&#39;)
                break
            except Exception:
                self.logger.error(&#39;Could not extract page.&#39;)
                break

        self.logger.info(&#39;Extracted {} regions.&#39;.format(len(regions)))
        return regions

    def extract_region_page(self) -&gt; Dict[str, str]:
        &#34;&#34;&#34;Extracts all regions from a discover page.

        Raises
        ------
        Exception
            If the current url does not contain the discover url
        &#34;&#34;&#34;

        # if current url does not contain the discover url
        # then we are not on a discover page and should raise an exception
        if self.discover_url not in self.driver.current_url:
            err = &#39;Could not extract regions from a discover page, as current url is not a discover page.&#39;
            self.logger.error(err)
            raise Exception(err)

        regions = {}

        self.logger.info(&#39;Extracting page: {}&#39;.format(self.driver.current_url))

        # Wait for the regions to appear
        el = self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;first_region_div&#39;])

        page_source = self.driver.page_source
        soup = BeautifulSoup(page_source, &#39;lxml&#39;)

        box = soup.findAll(&#39;div&#39;, attrs={
            &#39;class&#39;: &#39;js-href-box c-element-preview c-element-preview tw-overflow-hidden c-element-preview--middle&#39;})
        for b in box:
            link = b.find_next(&#39;a&#39;, attrs={
                &#39;class&#39;: &#39;tw-text-xl sm:tw-text-2xl tw-max-w-full tw-font-bold u-text-shadow tw-text-white tw-mb-0&#39;})
            url = self.base_url + link.attrs[&#39;href&#39;]
            name = link.text.strip()

            self.logger.info(&#39;Extracted region: {} -&gt; {}&#39;.format(name, url))
            regions[name] = url

        return regions

    def extract_routes_from_region(self, region: str, url: str) -&gt; List[str]:
        &#34;&#34;&#34;Extracts all routes from a region page.

        Parameters
        ----------
        region : str
            The name of the region
        url : str
            The url of the region page

        Raises
        ------
        Exception
            If the current url does not contain the region url
        &#34;&#34;&#34;

        # if current url does not contain the region url
        # then we are not on a region page and should raise an exception
        if self.region_url not in url:
            err = &#39;Could not extract routes from a region page, as current url is not a region page.&#39;
            self.logger.error(err)
            raise Exception(err)

        self.logger.info(&#39;Extracting routes from region: {} -&gt; {}&#39;.format(region, url))

        routes = []

        self.driver.get(url)

        page_source = self.driver.page_source
        soup = BeautifulSoup(page_source, &#39;lxml&#39;)

        for item in soup.select_one(self.page_objects[&#39;region&#39;][&#39;tours_list&#39;]):
            link = item.find_next(&#39;a&#39;)
            self.logger.info(&#39;Extracted route: {}&#39;.format(link.attrs[&#39;href&#39;]))
            routes.append(link.attrs[&#39;href&#39;])

        self.logger.info(&#39;Extracted {} routes from region: {}&#39;.format(len(routes), region))
        return routes

    def extract_route(self, url: str, retry_count: int = 0) -&gt; KomootRoute:
        &#34;&#34;&#34;Extracts all relevant data from a tour page.

        Parameters
        ----------
        url : str
            The url of the tour page
        retry_count : int (optional)
            The number of retries
            default: 0

        Raises
        ------
        Exception
            If the current url does not contain the route url
        &#34;&#34;&#34;

        # if current url does not contain the route url
        # then we are not on a route page and should raise an exception
        if self.route_url not in url:
            err = &#39;Could not extract routes from a region page, as current url is not a region page.&#39;
            self.logger.error(err)
            raise Exception(err)

        self.logger.info(&#39;Extracting data from tour: {}&#39;.format(url))

        try:
            self.driver.get(url)

            title = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;title_lbl&#39;]).text.strip()
            difficulty = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;difficulty_lbl&#39;]).text.strip()
            distance = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;distance_lbl&#39;]).text.strip()
            elevation_up = self.driver.find_element(By.XPATH,
                                                    self.page_objects[&#39;tour&#39;][&#39;elevation_up_lbl&#39;]).text.strip()
            elevation_down = self.driver.find_element(By.XPATH,
                                                      self.page_objects[&#39;tour&#39;][&#39;elevation_down_lbl&#39;]).text.strip()
            duration = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;duration_lbl&#39;]).text.strip()
            speed = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;speed_lbl&#39;]).text.strip()

            self.logger.info(&#39;Extracted data from tour: {} -&gt; {}&#39;.format(title, url))

            return KomootRoute(url, title, difficulty, distance, elevation_up, elevation_down, duration, speed)
        except Exception as e:
            self.logger.error(&#39;Could not extract data from tour: {}&#39;.format(url))
            self.logger.error(e)
            if retry_count &lt; self.max_retries:
                wait_seconds = self.retry_wait_seconds ** (retry_count + 1)

                self.logger.info(&#39;Retrying in {} seconds...&#39;.format(wait_seconds))
                sleep(wait_seconds)
                return self.extract_route(url, retry_count + 1)
            else:
                self.logger.info(&#39;Max retries exceeded. Skipping...&#39;)
                return None

    def handle_cookie_banner(self, accept: bool = False) -&gt; None:
        &#34;&#34;&#34;Handles the cookie banner if it appears.

        Parameters
        ----------
        accept : bool
            If true, the accept button will be clicked. If false, the decline button will be clicked.
            default: False
        &#34;&#34;&#34;

        btn = self.page_objects[&#39;cookie_banner&#39;][&#39;decline_btn&#39;]
        if accept:
            btn = self.page_objects[&#39;cookie_banner&#39;][&#39;accept_btn&#39;]

        self.logger.info(&#39;Searching for and handling cookie banner...&#39;)

        try:
            self.driver.find_element(By.XPATH, btn).click()
            self.logger.info(&#39;Cookies {}&#39;.format(&#39;accepted&#39; if accept else &#39;declined&#39;))
        except:
            self.logger.info(&#39;No cookie banner could be found&#39;)

    def handle_komoot_login(self) -&gt; None:
        &#34;&#34;&#34;Handles the Komoot login process.&#34;&#34;&#34;

        keyringServiceName = &#34;Komoot Login&#34;
        credentials = keyring.get_credential(keyringServiceName, &#34;philipp.drebes@gmail.com&#34;)

        self.logger.info(&#39;Logging in to Komoot...&#39;)
        self.driver.get(self.login_url)
        self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;email_input&#39;]).send_keys(credentials.username)
        self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;continue_btn&#39;]).click()
        self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;password_input&#39;]).send_keys(credentials.password)
        self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;login_btn&#39;]).click()
        sleep(20)
        self.logger.info(&#39;Logged in to Komoot.&#39;)

    def save(self, routes: List[KomootRoute]) -&gt; None:
        &#34;&#34;&#34;Saves the given routes to a csv file.

        Parameters
        ----------
        routes : List[KomootRoute]
            The routes to save
        &#34;&#34;&#34;

        self.logger.info(&#39;Saving {} routes to csv file...&#39;.format(len(routes)))

        df = pd.DataFrame([x.as_dict() for x in routes])
        df.to_csv(self.output_path, index=False)

        self.logger.info(&#39;Saved {} routes to csv file.&#39;.format(len(routes)))

    def read_existing_data(self) -&gt; List[KomootRoute]:
        return [(KomootRoute(
            row.link,
            row.title,
            row.difficulty,
            row.distance,
            row.elevation_up,
            row.elevation_down,
            row.duration,
            row.speed,
        )) for index, row in pd.read_csv(self.output_path).iterrows()]

    @staticmethod
    def chunks(data: Dict, size: int = 10):
        &#34;&#34;&#34;Yield successive n-sized chunks from data.

        Parameters
        ----------
        data : Dict
            The data to split
        size : int
            The size of each chunk
            default: 10
        &#34;&#34;&#34;

        it = iter(data)
        for i in range(0, len(data), size):
            yield {k: data[k] for k in islice(it, size)}</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="extractors.KomootExtractor.KomootExtractor"><code class="flex name class">
<span>class <span class="ident">KomootExtractor</span></span>
<span>(</span><span>driver: selenium.webdriver.chrome.webdriver.WebDriver, output_path: str, gpx_download_path: str)</span>
</code></dt>
<dd>
<div class="desc"><p>A class used to extract data from Komoot.com</p>
<h2 id="attributes">Attributes</h2>
<dl>
<dt><strong><code>base_url</code></strong> :&ensp;<code>str</code></dt>
<dd>a url string used as the base url for all other urls</dd>
<dt><strong><code>discover_url</code></strong> :&ensp;<code>str</code></dt>
<dd>A combination of the base_url and the discover url</dd>
<dt><strong><code>region_url</code></strong> :&ensp;<code>str</code></dt>
<dd>A combination of the base_url and the regions url</dd>
<dt><strong><code>tours_url</code></strong> :&ensp;<code>str</code></dt>
<dd>A combination of the base_url and the tours url</dd>
</dl>
<h2 id="methods">Methods</h2>
<p>extract()
Extracts all relevant data from the Komoot website.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>driver</code></strong> :&ensp;<code>WebDriver</code></dt>
<dd>The Selenium WebDriver used to interact with the browser</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class KomootExtractor:
    &#34;&#34;&#34;
    A class used to extract data from Komoot.com

    Attributes
    ----------
    base_url : str
        a url string used as the base url for all other urls
    discover_url : str
        A combination of the base_url and the discover url
    region_url : str
        A combination of the base_url and the regions url
    tours_url : str
        A combination of the base_url and the tours url

    Methods
    -------
    extract()
        Extracts all relevant data from the Komoot website.
    &#34;&#34;&#34;

    base_url = &#39;https://www.komoot.com&#39;
    discover_url = base_url + &#39;/discover/hiking-trails&#39;
    region_url = base_url + &#39;/guide&#39;
    route_url = base_url + &#39;/smarttour&#39;
    login_url = &#39;https://account.komoot.com/signin&#39;
    max_retries = 3
    retry_wait_seconds = 5

    page_objects = {
        &#39;discover&#39;: {
            &#39;filter_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/main/section[1]/div[2]/div/div[1]/div/div/button[1]&#39;,
            &#39;filter_close_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/main/section[1]/div[2]/div/div[2]/div/div[3]/div[2]/button/span&#39;,
            &#39;filter_country_ch_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/main/section[1]/div[2]/div/div[2]/div/div[2]/div/div[13]/label&#39;,
            &#39;next_page_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/main/section[1]/div[2]/div/div[3]/div[3]/button&#39;,
            &#39;first_region_div&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/main/section[1]/div[2]/div/div[2]/div/div[1]/div/div[3]/a&#39;
        },
        &#39;region&#39;: {
            &#39;tour_title_attr&#39;: &#39;data-test-id=&#34;tour_title&#34;&#39;,
            &#39;tours_list&#39;: &#39;#pageMountNode &gt; div &gt; div.tw-bg-beige-light &gt; div.u-bg-desk-column &gt; div &gt; section &gt; div &gt; div &gt; div &gt; div.tw-w-full.lg\:tw-w-3\/5 &gt; div &gt; div &gt; div:nth-child(2) &gt; div &gt; div:nth-child(2) &gt; ul&#39;,
        },
        &#39;tour&#39;: {
            &#39;title_lbl&#39;: &#39;//*[@id=&#34;title&#34;]/div[2]/h1&#39;,
            &#39;difficulty_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[1]/div/div&#39;,
            &#39;duration_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[2]/div/div/div[2]/div/div/span&#39;,
            &#39;distance_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[3]/div/div/div[2]/span&#39;,
            &#39;speed_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[4]/div/div/div[2]/div/div/span&#39;,
            &#39;elevation_up_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[5]/div/div/div[2]/span&#39;,
            &#39;elevation_down_lbl&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[1]/div/div/div/div[2]/div/div[2]/div/div[6]/div/div/div[2]/span&#39;,
            &#39;gpx_download_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[3]/div[2]/div/div/div/div/div[2]/div/div/div/div[1]/div/div[2]/div/ul/li[3]/button&#39;
        },
        &#39;login&#39;: {
            &#39;email_input&#39;: &#39;//*[@id=&#34;email&#34;]&#39;,
            &#39;password_input&#39;: &#39;//*[@id=&#34;password&#34;]&#39;,
            &#39;continue_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[1]/div[2]/div/div[1]/form/div[4]/button&#39;,
            &#39;login_btn&#39;: &#39;//*[@id=&#34;pageMountNode&#34;]/div/div[1]/div[2]/form/div/div[5]/button&#39;
        },
        &#39;cookie_banner&#39;: {
            &#39;accept_btn&#39;: &#39;//*[@id=&#34;gdpr_banner_portal&#34;]/div/div/div/div[2]/div/div[1]/button&#39;,
            &#39;decline_btn&#39;: &#39;//*[@id=&#34;gdpr_banner_portal&#34;]/div/div/div/div[2]/div/div[3]/button&#39;
        }
    }

    def __init__(self, driver: WebDriver, output_path: str, gpx_download_path: str) -&gt; None:
        &#34;&#34;&#34;
        Parameters
        ----------
        driver : WebDriver
            The Selenium WebDriver used to interact with the browser
        &#34;&#34;&#34;
        self.driver = driver
        self.driver.implicitly_wait(15)
        self.output_path = output_path
        self.gpx_download_path = gpx_download_path
        self.logger = logging.getLogger(__name__)

    def extract(self) -&gt; None:
        &#34;&#34;&#34;Extracts all relevant data from the Komoot website.&#34;&#34;&#34;

        self.logger.info(&#39;Starting Komoot extraction...&#39;)
        regions = self.extract_ch_regions()

        existing = self.read_existing_data()

        routes: List[KomootRoute] = existing

        # split regions dictionary into chunks of 20
        for chunk in self.chunks(regions, 20):
            for region in chunk:
                for route in self.extract_routes_from_region(region, chunk[region]):

                    # check if route is already in existing routes by comparing the link
                    if route not in [r.link for r in routes]:
                        routes.append(self.extract_route(route))
                        sleep(5)  # Sleep 5 seconds to avoid getting rate limited

            self.logger.info(&#39;Saving current state...&#39;)
            self.save(routes)  # Save routes after each chunk to avoid losing data
            sleep(120)  # Sleep for 120 seconds to avoid getting rate limited

        self.logger.info(&#39;Finished Komoot extraction.&#39;)

        self.logger.info(&#39;Saving Komoot data...&#39;)
        self.save(routes)
        self.logger.info(&#39;Saved Komoot data.&#39;)

    def extract_gpx(self) -&gt; None:
        &#34;&#34;&#34; Extracts the GPX files for all routes in the output file.  &#34;&#34;&#34;

        existing = self.read_existing_data()

        self.handle_komoot_login()

        existing_gpx_files = os.listdir(self.gpx_download_path)

        for idx, route in enumerate(existing):
            pattern = re.compile(route.title + &#34;\.gpx$&#34;)
            for filepath in existing_gpx_files:
                if pattern.match(filepath):
                    self.logger.info(f&#39;GPX for route {route.title} already exists. Skipping...&#39;)
                    continue

            self.logger.info(f&#39;Downloading GPX for route {route.title}...&#39;)

            link = route.link.replace(&#39;https://www.komoot.com/&#39;, &#39;https://www.komoot.de/&#39;)

            self.driver.get(link)
            self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;gpx_download_btn&#39;]).click()
            self.logger.info(f&#39;Downloaded GPX for route {route.title}.&#39;)
            sleep(5)  # Sleep 5 seconds to avoid getting rate limited
            if idx % 40 == 0:
                self.logger.info(&#39;Sleeping for 120 seconds...&#39;)
                sleep(120)

    def extract_ch_regions(self) -&gt; Dict[str, str]:
        &#34;&#34;&#34;Extracts all regions from the Komoot discover page. &#34;&#34;&#34;

        self.logger.info(&#39;Extracting all regions in Switzerland...&#39;)

        self.driver.get(self.discover_url)
        self.handle_cookie_banner()

        # Filter region to Switzerland
        self.logger.debug(&#39;Filter region to Switzerland...&#39;)
        self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;filter_btn&#39;]).click()
        self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;filter_country_ch_lbl&#39;]).click()
        self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;filter_close_btn&#39;]).click()

        regions = {}

        # Get all regions
        while True:
            regions = regions | self.extract_region_page()

            # Check if there is a next page button
            try:
                SeleniumUtil.scroll_to_position(self.driver, 1500)
                self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;next_page_btn&#39;]).click()
            except ElementNotInteractableException:
                self.logger.info(&#39;No more pages to extract.&#39;)
                break
            except Exception:
                self.logger.error(&#39;Could not extract page.&#39;)
                break

        self.logger.info(&#39;Extracted {} regions.&#39;.format(len(regions)))
        return regions

    def extract_region_page(self) -&gt; Dict[str, str]:
        &#34;&#34;&#34;Extracts all regions from a discover page.

        Raises
        ------
        Exception
            If the current url does not contain the discover url
        &#34;&#34;&#34;

        # if current url does not contain the discover url
        # then we are not on a discover page and should raise an exception
        if self.discover_url not in self.driver.current_url:
            err = &#39;Could not extract regions from a discover page, as current url is not a discover page.&#39;
            self.logger.error(err)
            raise Exception(err)

        regions = {}

        self.logger.info(&#39;Extracting page: {}&#39;.format(self.driver.current_url))

        # Wait for the regions to appear
        el = self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;first_region_div&#39;])

        page_source = self.driver.page_source
        soup = BeautifulSoup(page_source, &#39;lxml&#39;)

        box = soup.findAll(&#39;div&#39;, attrs={
            &#39;class&#39;: &#39;js-href-box c-element-preview c-element-preview tw-overflow-hidden c-element-preview--middle&#39;})
        for b in box:
            link = b.find_next(&#39;a&#39;, attrs={
                &#39;class&#39;: &#39;tw-text-xl sm:tw-text-2xl tw-max-w-full tw-font-bold u-text-shadow tw-text-white tw-mb-0&#39;})
            url = self.base_url + link.attrs[&#39;href&#39;]
            name = link.text.strip()

            self.logger.info(&#39;Extracted region: {} -&gt; {}&#39;.format(name, url))
            regions[name] = url

        return regions

    def extract_routes_from_region(self, region: str, url: str) -&gt; List[str]:
        &#34;&#34;&#34;Extracts all routes from a region page.

        Parameters
        ----------
        region : str
            The name of the region
        url : str
            The url of the region page

        Raises
        ------
        Exception
            If the current url does not contain the region url
        &#34;&#34;&#34;

        # if current url does not contain the region url
        # then we are not on a region page and should raise an exception
        if self.region_url not in url:
            err = &#39;Could not extract routes from a region page, as current url is not a region page.&#39;
            self.logger.error(err)
            raise Exception(err)

        self.logger.info(&#39;Extracting routes from region: {} -&gt; {}&#39;.format(region, url))

        routes = []

        self.driver.get(url)

        page_source = self.driver.page_source
        soup = BeautifulSoup(page_source, &#39;lxml&#39;)

        for item in soup.select_one(self.page_objects[&#39;region&#39;][&#39;tours_list&#39;]):
            link = item.find_next(&#39;a&#39;)
            self.logger.info(&#39;Extracted route: {}&#39;.format(link.attrs[&#39;href&#39;]))
            routes.append(link.attrs[&#39;href&#39;])

        self.logger.info(&#39;Extracted {} routes from region: {}&#39;.format(len(routes), region))
        return routes

    def extract_route(self, url: str, retry_count: int = 0) -&gt; KomootRoute:
        &#34;&#34;&#34;Extracts all relevant data from a tour page.

        Parameters
        ----------
        url : str
            The url of the tour page
        retry_count : int (optional)
            The number of retries
            default: 0

        Raises
        ------
        Exception
            If the current url does not contain the route url
        &#34;&#34;&#34;

        # if current url does not contain the route url
        # then we are not on a route page and should raise an exception
        if self.route_url not in url:
            err = &#39;Could not extract routes from a region page, as current url is not a region page.&#39;
            self.logger.error(err)
            raise Exception(err)

        self.logger.info(&#39;Extracting data from tour: {}&#39;.format(url))

        try:
            self.driver.get(url)

            title = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;title_lbl&#39;]).text.strip()
            difficulty = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;difficulty_lbl&#39;]).text.strip()
            distance = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;distance_lbl&#39;]).text.strip()
            elevation_up = self.driver.find_element(By.XPATH,
                                                    self.page_objects[&#39;tour&#39;][&#39;elevation_up_lbl&#39;]).text.strip()
            elevation_down = self.driver.find_element(By.XPATH,
                                                      self.page_objects[&#39;tour&#39;][&#39;elevation_down_lbl&#39;]).text.strip()
            duration = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;duration_lbl&#39;]).text.strip()
            speed = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;speed_lbl&#39;]).text.strip()

            self.logger.info(&#39;Extracted data from tour: {} -&gt; {}&#39;.format(title, url))

            return KomootRoute(url, title, difficulty, distance, elevation_up, elevation_down, duration, speed)
        except Exception as e:
            self.logger.error(&#39;Could not extract data from tour: {}&#39;.format(url))
            self.logger.error(e)
            if retry_count &lt; self.max_retries:
                wait_seconds = self.retry_wait_seconds ** (retry_count + 1)

                self.logger.info(&#39;Retrying in {} seconds...&#39;.format(wait_seconds))
                sleep(wait_seconds)
                return self.extract_route(url, retry_count + 1)
            else:
                self.logger.info(&#39;Max retries exceeded. Skipping...&#39;)
                return None

    def handle_cookie_banner(self, accept: bool = False) -&gt; None:
        &#34;&#34;&#34;Handles the cookie banner if it appears.

        Parameters
        ----------
        accept : bool
            If true, the accept button will be clicked. If false, the decline button will be clicked.
            default: False
        &#34;&#34;&#34;

        btn = self.page_objects[&#39;cookie_banner&#39;][&#39;decline_btn&#39;]
        if accept:
            btn = self.page_objects[&#39;cookie_banner&#39;][&#39;accept_btn&#39;]

        self.logger.info(&#39;Searching for and handling cookie banner...&#39;)

        try:
            self.driver.find_element(By.XPATH, btn).click()
            self.logger.info(&#39;Cookies {}&#39;.format(&#39;accepted&#39; if accept else &#39;declined&#39;))
        except:
            self.logger.info(&#39;No cookie banner could be found&#39;)

    def handle_komoot_login(self) -&gt; None:
        &#34;&#34;&#34;Handles the Komoot login process.&#34;&#34;&#34;

        keyringServiceName = &#34;Komoot Login&#34;
        credentials = keyring.get_credential(keyringServiceName, &#34;philipp.drebes@gmail.com&#34;)

        self.logger.info(&#39;Logging in to Komoot...&#39;)
        self.driver.get(self.login_url)
        self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;email_input&#39;]).send_keys(credentials.username)
        self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;continue_btn&#39;]).click()
        self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;password_input&#39;]).send_keys(credentials.password)
        self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;login_btn&#39;]).click()
        sleep(20)
        self.logger.info(&#39;Logged in to Komoot.&#39;)

    def save(self, routes: List[KomootRoute]) -&gt; None:
        &#34;&#34;&#34;Saves the given routes to a csv file.

        Parameters
        ----------
        routes : List[KomootRoute]
            The routes to save
        &#34;&#34;&#34;

        self.logger.info(&#39;Saving {} routes to csv file...&#39;.format(len(routes)))

        df = pd.DataFrame([x.as_dict() for x in routes])
        df.to_csv(self.output_path, index=False)

        self.logger.info(&#39;Saved {} routes to csv file.&#39;.format(len(routes)))

    def read_existing_data(self) -&gt; List[KomootRoute]:
        return [(KomootRoute(
            row.link,
            row.title,
            row.difficulty,
            row.distance,
            row.elevation_up,
            row.elevation_down,
            row.duration,
            row.speed,
        )) for index, row in pd.read_csv(self.output_path).iterrows()]

    @staticmethod
    def chunks(data: Dict, size: int = 10):
        &#34;&#34;&#34;Yield successive n-sized chunks from data.

        Parameters
        ----------
        data : Dict
            The data to split
        size : int
            The size of each chunk
            default: 10
        &#34;&#34;&#34;

        it = iter(data)
        for i in range(0, len(data), size):
            yield {k: data[k] for k in islice(it, size)}</code></pre>
</details>
<h3>Class variables</h3>
<dl>
<dt id="extractors.KomootExtractor.KomootExtractor.base_url"><code class="name">var <span class="ident">base_url</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.discover_url"><code class="name">var <span class="ident">discover_url</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.login_url"><code class="name">var <span class="ident">login_url</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.max_retries"><code class="name">var <span class="ident">max_retries</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.page_objects"><code class="name">var <span class="ident">page_objects</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.region_url"><code class="name">var <span class="ident">region_url</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.retry_wait_seconds"><code class="name">var <span class="ident">retry_wait_seconds</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.route_url"><code class="name">var <span class="ident">route_url</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
<h3>Static methods</h3>
<dl>
<dt id="extractors.KomootExtractor.KomootExtractor.chunks"><code class="name flex">
<span>def <span class="ident">chunks</span></span>(<span>data: Dict, size: int = 10)</span>
</code></dt>
<dd>
<div class="desc"><p>Yield successive n-sized chunks from data.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>data</code></strong> :&ensp;<code>Dict</code></dt>
<dd>The data to split</dd>
<dt><strong><code>size</code></strong> :&ensp;<code>int</code></dt>
<dd>The size of each chunk
default: 10</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def chunks(data: Dict, size: int = 10):
    &#34;&#34;&#34;Yield successive n-sized chunks from data.

    Parameters
    ----------
    data : Dict
        The data to split
    size : int
        The size of each chunk
        default: 10
    &#34;&#34;&#34;

    it = iter(data)
    for i in range(0, len(data), size):
        yield {k: data[k] for k in islice(it, size)}</code></pre>
</details>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="extractors.KomootExtractor.KomootExtractor.extract"><code class="name flex">
<span>def <span class="ident">extract</span></span>(<span>self) ‑> None</span>
</code></dt>
<dd>
<div class="desc"><p>Extracts all relevant data from the Komoot website.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def extract(self) -&gt; None:
    &#34;&#34;&#34;Extracts all relevant data from the Komoot website.&#34;&#34;&#34;

    self.logger.info(&#39;Starting Komoot extraction...&#39;)
    regions = self.extract_ch_regions()

    existing = self.read_existing_data()

    routes: List[KomootRoute] = existing

    # split regions dictionary into chunks of 20
    for chunk in self.chunks(regions, 20):
        for region in chunk:
            for route in self.extract_routes_from_region(region, chunk[region]):

                # check if route is already in existing routes by comparing the link
                if route not in [r.link for r in routes]:
                    routes.append(self.extract_route(route))
                    sleep(5)  # Sleep 5 seconds to avoid getting rate limited

        self.logger.info(&#39;Saving current state...&#39;)
        self.save(routes)  # Save routes after each chunk to avoid losing data
        sleep(120)  # Sleep for 120 seconds to avoid getting rate limited

    self.logger.info(&#39;Finished Komoot extraction.&#39;)

    self.logger.info(&#39;Saving Komoot data...&#39;)
    self.save(routes)
    self.logger.info(&#39;Saved Komoot data.&#39;)</code></pre>
</details>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.extract_ch_regions"><code class="name flex">
<span>def <span class="ident">extract_ch_regions</span></span>(<span>self) ‑> Dict[str, str]</span>
</code></dt>
<dd>
<div class="desc"><p>Extracts all regions from the Komoot discover page.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def extract_ch_regions(self) -&gt; Dict[str, str]:
    &#34;&#34;&#34;Extracts all regions from the Komoot discover page. &#34;&#34;&#34;

    self.logger.info(&#39;Extracting all regions in Switzerland...&#39;)

    self.driver.get(self.discover_url)
    self.handle_cookie_banner()

    # Filter region to Switzerland
    self.logger.debug(&#39;Filter region to Switzerland...&#39;)
    self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;filter_btn&#39;]).click()
    self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;filter_country_ch_lbl&#39;]).click()
    self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;filter_close_btn&#39;]).click()

    regions = {}

    # Get all regions
    while True:
        regions = regions | self.extract_region_page()

        # Check if there is a next page button
        try:
            SeleniumUtil.scroll_to_position(self.driver, 1500)
            self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;next_page_btn&#39;]).click()
        except ElementNotInteractableException:
            self.logger.info(&#39;No more pages to extract.&#39;)
            break
        except Exception:
            self.logger.error(&#39;Could not extract page.&#39;)
            break

    self.logger.info(&#39;Extracted {} regions.&#39;.format(len(regions)))
    return regions</code></pre>
</details>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.extract_gpx"><code class="name flex">
<span>def <span class="ident">extract_gpx</span></span>(<span>self) ‑> None</span>
</code></dt>
<dd>
<div class="desc"><p>Extracts the GPX files for all routes in the output file.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def extract_gpx(self) -&gt; None:
    &#34;&#34;&#34; Extracts the GPX files for all routes in the output file.  &#34;&#34;&#34;

    existing = self.read_existing_data()

    self.handle_komoot_login()

    existing_gpx_files = os.listdir(self.gpx_download_path)

    for idx, route in enumerate(existing):
        pattern = re.compile(route.title + &#34;\.gpx$&#34;)
        for filepath in existing_gpx_files:
            if pattern.match(filepath):
                self.logger.info(f&#39;GPX for route {route.title} already exists. Skipping...&#39;)
                continue

        self.logger.info(f&#39;Downloading GPX for route {route.title}...&#39;)

        link = route.link.replace(&#39;https://www.komoot.com/&#39;, &#39;https://www.komoot.de/&#39;)

        self.driver.get(link)
        self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;gpx_download_btn&#39;]).click()
        self.logger.info(f&#39;Downloaded GPX for route {route.title}.&#39;)
        sleep(5)  # Sleep 5 seconds to avoid getting rate limited
        if idx % 40 == 0:
            self.logger.info(&#39;Sleeping for 120 seconds...&#39;)
            sleep(120)</code></pre>
</details>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.extract_region_page"><code class="name flex">
<span>def <span class="ident">extract_region_page</span></span>(<span>self) ‑> Dict[str, str]</span>
</code></dt>
<dd>
<div class="desc"><p>Extracts all regions from a discover page.</p>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>Exception</code></dt>
<dd>If the current url does not contain the discover url</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def extract_region_page(self) -&gt; Dict[str, str]:
    &#34;&#34;&#34;Extracts all regions from a discover page.

    Raises
    ------
    Exception
        If the current url does not contain the discover url
    &#34;&#34;&#34;

    # if current url does not contain the discover url
    # then we are not on a discover page and should raise an exception
    if self.discover_url not in self.driver.current_url:
        err = &#39;Could not extract regions from a discover page, as current url is not a discover page.&#39;
        self.logger.error(err)
        raise Exception(err)

    regions = {}

    self.logger.info(&#39;Extracting page: {}&#39;.format(self.driver.current_url))

    # Wait for the regions to appear
    el = self.driver.find_element(By.XPATH, self.page_objects[&#39;discover&#39;][&#39;first_region_div&#39;])

    page_source = self.driver.page_source
    soup = BeautifulSoup(page_source, &#39;lxml&#39;)

    box = soup.findAll(&#39;div&#39;, attrs={
        &#39;class&#39;: &#39;js-href-box c-element-preview c-element-preview tw-overflow-hidden c-element-preview--middle&#39;})
    for b in box:
        link = b.find_next(&#39;a&#39;, attrs={
            &#39;class&#39;: &#39;tw-text-xl sm:tw-text-2xl tw-max-w-full tw-font-bold u-text-shadow tw-text-white tw-mb-0&#39;})
        url = self.base_url + link.attrs[&#39;href&#39;]
        name = link.text.strip()

        self.logger.info(&#39;Extracted region: {} -&gt; {}&#39;.format(name, url))
        regions[name] = url

    return regions</code></pre>
</details>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.extract_route"><code class="name flex">
<span>def <span class="ident">extract_route</span></span>(<span>self, url: str, retry_count: int = 0) ‑> src.model.Komoot.Route.KomootRoute</span>
</code></dt>
<dd>
<div class="desc"><p>Extracts all relevant data from a tour page.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>url</code></strong> :&ensp;<code>str</code></dt>
<dd>The url of the tour page</dd>
<dt><strong><code>retry_count</code></strong> :&ensp;<code>int (optional)</code></dt>
<dd>The number of retries
default: 0</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>Exception</code></dt>
<dd>If the current url does not contain the route url</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def extract_route(self, url: str, retry_count: int = 0) -&gt; KomootRoute:
    &#34;&#34;&#34;Extracts all relevant data from a tour page.

    Parameters
    ----------
    url : str
        The url of the tour page
    retry_count : int (optional)
        The number of retries
        default: 0

    Raises
    ------
    Exception
        If the current url does not contain the route url
    &#34;&#34;&#34;

    # if current url does not contain the route url
    # then we are not on a route page and should raise an exception
    if self.route_url not in url:
        err = &#39;Could not extract routes from a region page, as current url is not a region page.&#39;
        self.logger.error(err)
        raise Exception(err)

    self.logger.info(&#39;Extracting data from tour: {}&#39;.format(url))

    try:
        self.driver.get(url)

        title = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;title_lbl&#39;]).text.strip()
        difficulty = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;difficulty_lbl&#39;]).text.strip()
        distance = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;distance_lbl&#39;]).text.strip()
        elevation_up = self.driver.find_element(By.XPATH,
                                                self.page_objects[&#39;tour&#39;][&#39;elevation_up_lbl&#39;]).text.strip()
        elevation_down = self.driver.find_element(By.XPATH,
                                                  self.page_objects[&#39;tour&#39;][&#39;elevation_down_lbl&#39;]).text.strip()
        duration = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;duration_lbl&#39;]).text.strip()
        speed = self.driver.find_element(By.XPATH, self.page_objects[&#39;tour&#39;][&#39;speed_lbl&#39;]).text.strip()

        self.logger.info(&#39;Extracted data from tour: {} -&gt; {}&#39;.format(title, url))

        return KomootRoute(url, title, difficulty, distance, elevation_up, elevation_down, duration, speed)
    except Exception as e:
        self.logger.error(&#39;Could not extract data from tour: {}&#39;.format(url))
        self.logger.error(e)
        if retry_count &lt; self.max_retries:
            wait_seconds = self.retry_wait_seconds ** (retry_count + 1)

            self.logger.info(&#39;Retrying in {} seconds...&#39;.format(wait_seconds))
            sleep(wait_seconds)
            return self.extract_route(url, retry_count + 1)
        else:
            self.logger.info(&#39;Max retries exceeded. Skipping...&#39;)
            return None</code></pre>
</details>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.extract_routes_from_region"><code class="name flex">
<span>def <span class="ident">extract_routes_from_region</span></span>(<span>self, region: str, url: str) ‑> List[str]</span>
</code></dt>
<dd>
<div class="desc"><p>Extracts all routes from a region page.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>region</code></strong> :&ensp;<code>str</code></dt>
<dd>The name of the region</dd>
<dt><strong><code>url</code></strong> :&ensp;<code>str</code></dt>
<dd>The url of the region page</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>Exception</code></dt>
<dd>If the current url does not contain the region url</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def extract_routes_from_region(self, region: str, url: str) -&gt; List[str]:
    &#34;&#34;&#34;Extracts all routes from a region page.

    Parameters
    ----------
    region : str
        The name of the region
    url : str
        The url of the region page

    Raises
    ------
    Exception
        If the current url does not contain the region url
    &#34;&#34;&#34;

    # if current url does not contain the region url
    # then we are not on a region page and should raise an exception
    if self.region_url not in url:
        err = &#39;Could not extract routes from a region page, as current url is not a region page.&#39;
        self.logger.error(err)
        raise Exception(err)

    self.logger.info(&#39;Extracting routes from region: {} -&gt; {}&#39;.format(region, url))

    routes = []

    self.driver.get(url)

    page_source = self.driver.page_source
    soup = BeautifulSoup(page_source, &#39;lxml&#39;)

    for item in soup.select_one(self.page_objects[&#39;region&#39;][&#39;tours_list&#39;]):
        link = item.find_next(&#39;a&#39;)
        self.logger.info(&#39;Extracted route: {}&#39;.format(link.attrs[&#39;href&#39;]))
        routes.append(link.attrs[&#39;href&#39;])

    self.logger.info(&#39;Extracted {} routes from region: {}&#39;.format(len(routes), region))
    return routes</code></pre>
</details>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.handle_cookie_banner"><code class="name flex">
<span>def <span class="ident">handle_cookie_banner</span></span>(<span>self, accept: bool = False) ‑> None</span>
</code></dt>
<dd>
<div class="desc"><p>Handles the cookie banner if it appears.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>accept</code></strong> :&ensp;<code>bool</code></dt>
<dd>If true, the accept button will be clicked. If false, the decline button will be clicked.
default: False</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def handle_cookie_banner(self, accept: bool = False) -&gt; None:
    &#34;&#34;&#34;Handles the cookie banner if it appears.

    Parameters
    ----------
    accept : bool
        If true, the accept button will be clicked. If false, the decline button will be clicked.
        default: False
    &#34;&#34;&#34;

    btn = self.page_objects[&#39;cookie_banner&#39;][&#39;decline_btn&#39;]
    if accept:
        btn = self.page_objects[&#39;cookie_banner&#39;][&#39;accept_btn&#39;]

    self.logger.info(&#39;Searching for and handling cookie banner...&#39;)

    try:
        self.driver.find_element(By.XPATH, btn).click()
        self.logger.info(&#39;Cookies {}&#39;.format(&#39;accepted&#39; if accept else &#39;declined&#39;))
    except:
        self.logger.info(&#39;No cookie banner could be found&#39;)</code></pre>
</details>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.handle_komoot_login"><code class="name flex">
<span>def <span class="ident">handle_komoot_login</span></span>(<span>self) ‑> None</span>
</code></dt>
<dd>
<div class="desc"><p>Handles the Komoot login process.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def handle_komoot_login(self) -&gt; None:
    &#34;&#34;&#34;Handles the Komoot login process.&#34;&#34;&#34;

    keyringServiceName = &#34;Komoot Login&#34;
    credentials = keyring.get_credential(keyringServiceName, &#34;philipp.drebes@gmail.com&#34;)

    self.logger.info(&#39;Logging in to Komoot...&#39;)
    self.driver.get(self.login_url)
    self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;email_input&#39;]).send_keys(credentials.username)
    self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;continue_btn&#39;]).click()
    self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;password_input&#39;]).send_keys(credentials.password)
    self.driver.find_element(By.XPATH, self.page_objects[&#39;login&#39;][&#39;login_btn&#39;]).click()
    sleep(20)
    self.logger.info(&#39;Logged in to Komoot.&#39;)</code></pre>
</details>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.read_existing_data"><code class="name flex">
<span>def <span class="ident">read_existing_data</span></span>(<span>self) ‑> List[src.model.Komoot.Route.KomootRoute]</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def read_existing_data(self) -&gt; List[KomootRoute]:
    return [(KomootRoute(
        row.link,
        row.title,
        row.difficulty,
        row.distance,
        row.elevation_up,
        row.elevation_down,
        row.duration,
        row.speed,
    )) for index, row in pd.read_csv(self.output_path).iterrows()]</code></pre>
</details>
</dd>
<dt id="extractors.KomootExtractor.KomootExtractor.save"><code class="name flex">
<span>def <span class="ident">save</span></span>(<span>self, routes: List[src.model.Komoot.Route.KomootRoute]) ‑> None</span>
</code></dt>
<dd>
<div class="desc"><p>Saves the given routes to a csv file.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>routes</code></strong> :&ensp;<code>List[KomootRoute]</code></dt>
<dd>The routes to save</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def save(self, routes: List[KomootRoute]) -&gt; None:
    &#34;&#34;&#34;Saves the given routes to a csv file.

    Parameters
    ----------
    routes : List[KomootRoute]
        The routes to save
    &#34;&#34;&#34;

    self.logger.info(&#39;Saving {} routes to csv file...&#39;.format(len(routes)))

    df = pd.DataFrame([x.as_dict() for x in routes])
    df.to_csv(self.output_path, index=False)

    self.logger.info(&#39;Saved {} routes to csv file.&#39;.format(len(routes)))</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="extractors" href="index.html">extractors</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="extractors.KomootExtractor.KomootExtractor" href="#extractors.KomootExtractor.KomootExtractor">KomootExtractor</a></code></h4>
<ul class="">
<li><code><a title="extractors.KomootExtractor.KomootExtractor.base_url" href="#extractors.KomootExtractor.KomootExtractor.base_url">base_url</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.chunks" href="#extractors.KomootExtractor.KomootExtractor.chunks">chunks</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.discover_url" href="#extractors.KomootExtractor.KomootExtractor.discover_url">discover_url</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.extract" href="#extractors.KomootExtractor.KomootExtractor.extract">extract</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.extract_ch_regions" href="#extractors.KomootExtractor.KomootExtractor.extract_ch_regions">extract_ch_regions</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.extract_gpx" href="#extractors.KomootExtractor.KomootExtractor.extract_gpx">extract_gpx</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.extract_region_page" href="#extractors.KomootExtractor.KomootExtractor.extract_region_page">extract_region_page</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.extract_route" href="#extractors.KomootExtractor.KomootExtractor.extract_route">extract_route</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.extract_routes_from_region" href="#extractors.KomootExtractor.KomootExtractor.extract_routes_from_region">extract_routes_from_region</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.handle_cookie_banner" href="#extractors.KomootExtractor.KomootExtractor.handle_cookie_banner">handle_cookie_banner</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.handle_komoot_login" href="#extractors.KomootExtractor.KomootExtractor.handle_komoot_login">handle_komoot_login</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.login_url" href="#extractors.KomootExtractor.KomootExtractor.login_url">login_url</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.max_retries" href="#extractors.KomootExtractor.KomootExtractor.max_retries">max_retries</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.page_objects" href="#extractors.KomootExtractor.KomootExtractor.page_objects">page_objects</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.read_existing_data" href="#extractors.KomootExtractor.KomootExtractor.read_existing_data">read_existing_data</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.region_url" href="#extractors.KomootExtractor.KomootExtractor.region_url">region_url</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.retry_wait_seconds" href="#extractors.KomootExtractor.KomootExtractor.retry_wait_seconds">retry_wait_seconds</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.route_url" href="#extractors.KomootExtractor.KomootExtractor.route_url">route_url</a></code></li>
<li><code><a title="extractors.KomootExtractor.KomootExtractor.save" href="#extractors.KomootExtractor.KomootExtractor.save">save</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>